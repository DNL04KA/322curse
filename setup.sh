#!/bin/bash

# =============================================================================
# üöÄ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê –ü–†–û–ï–ö–¢–ê FOOD ORDER
# =============================================================================
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–∏—Ç –ø—Ä–æ–µ–∫—Ç –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
# –ü–æ–¥–¥–µ—Ä–∂–∫–∞: macOS —Å Homebrew –∏–ª–∏ Laravel Herd
# =============================================================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
print_step() {
    echo -e "\n${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}‚ñ∂ $1${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"
}

print_success() {
    echo -e "${GREEN}‚úì $1${NC}"
}

print_error() {
    echo -e "${RED}‚úó $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚Ñπ $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–µ –∏–∑-–ø–æ–¥ root
if [ "$EUID" -eq 0 ]; then 
    print_error "–ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–¥ root (sudo)!"
    print_info "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ: ./setup.sh"
    exit 1
fi

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
clear
echo -e "${CYAN}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                               ‚ïë
‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó                          ‚ïë
‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó                         ‚ïë
‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë                         ‚ïë
‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë                         ‚ïë
‚ïë   ‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù                         ‚ïë
‚ïë   ‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù                          ‚ïë
‚ïë                                                               ‚ïë
‚ïë    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó                   ‚ïë
‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó                  ‚ïë
‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù                  ‚ïë
‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó                  ‚ïë
‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë                  ‚ïë
‚ïë    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù                  ‚ïë
‚ïë                                                               ‚ïë
‚ïë               –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê                        ‚ïë
‚ïë                                                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}\n"

print_info "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
print_info "–í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏: ~5-10 –º–∏–Ω—É—Ç\n"

# =============================================================================
# –®–ê–ì 1: –ü–†–û–í–ï–†–ö–ê –°–ò–°–¢–ï–ú–´
# =============================================================================

print_step "–®–ê–ì 1/10: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    print_error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è macOS"
    print_info "–î–ª—è Windows –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ install.bat"
    print_info "–î–ª—è Linux –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤–∞—à–µ–≥–æ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞"
    exit 1
fi

print_success "macOS –æ–±–Ω–∞—Ä—É–∂–µ–Ω: $(sw_vers -productVersion)"

# =============================================================================
# –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê –ò –£–°–¢–ê–ù–û–í–ö–ê HOMEBREW
# =============================================================================

print_step "–®–ê–ì 2/10: –ü—Ä–æ–≤–µ—Ä–∫–∞ Homebrew"

if ! command -v brew &> /dev/null; then
    print_warning "Homebrew –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Homebrew –≤ PATH –¥–ª—è Apple Silicon
    if [[ $(uname -m) == 'arm64' ]]; then
        echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
    
    print_success "Homebrew —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    print_success "Homebrew —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(brew --version | head -n1)"
fi

# =============================================================================
# –®–ê–ì 3: –ü–†–û–í–ï–†–ö–ê –ò –£–°–¢–ê–ù–û–í–ö–ê PHP
# =============================================================================

print_step "–®–ê–ì 3/10: –ü—Ä–æ–≤–µ—Ä–∫–∞ PHP"

if command -v php &> /dev/null; then
    PHP_VERSION=$(php -v | head -n1 | cut -d" " -f2 | cut -d"." -f1,2)
    print_success "PHP —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(php -v | head -n1)"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ PHP
    if (( $(echo "$PHP_VERSION < 8.2" | bc -l) )); then
        print_warning "–¢—Ä–µ–±—É–µ—Ç—Å—è PHP >= 8.2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PHP 8.3..."
        brew install php@8.3
        brew link php@8.3 --force --overwrite
    fi
else
    print_warning "PHP –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PHP 8.3..."
    brew install php@8.3
    brew link php@8.3 --force --overwrite
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π PHP
print_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π PHP..."
REQUIRED_EXTENSIONS=("pdo_mysql" "mbstring" "xml" "curl" "zip")
MISSING_EXTENSIONS=()

for ext in "${REQUIRED_EXTENSIONS[@]}"; do
    if ! php -m | grep -qi "^$ext$" 2>/dev/null; then
        MISSING_EXTENSIONS+=("$ext")
    fi
done

if [ ${#MISSING_EXTENSIONS[@]} -gt 0 ]; then
    print_warning "–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è: ${MISSING_EXTENSIONS[*]}"
    print_info "–û–Ω–∏ –æ–±—ã—á–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã –≤ PHP –∏–∑ Homebrew"
fi

print_success "PHP –≥–æ—Ç–æ–≤: $(php -v | head -n1 | awk '{print $2}')"

# =============================================================================
# –®–ê–ì 4: –ü–†–û–í–ï–†–ö–ê –ò –£–°–¢–ê–ù–û–í–ö–ê COMPOSER
# =============================================================================

print_step "–®–ê–ì 4/10: –ü—Ä–æ–≤–µ—Ä–∫–∞ Composer"

if ! command -v composer &> /dev/null; then
    print_warning "Composer –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    brew install composer
    print_success "Composer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    print_success "Composer —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(composer --version --no-ansi | head -n1)"
fi

# =============================================================================
# –®–ê–ì 5: –ü–†–û–í–ï–†–ö–ê –ò –£–°–¢–ê–ù–û–í–ö–ê NODE.JS
# =============================================================================

print_step "–®–ê–ì 5/10: –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js –∏ npm"

if ! command -v node &> /dev/null; then
    print_warning "Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    brew install node
    print_success "Node.js —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    print_success "Node.js —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(node -v)"
fi

if ! command -v npm &> /dev/null; then
    print_error "npm –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
else
    print_success "npm –≥–æ—Ç–æ–≤: $(npm -v)"
fi

# =============================================================================
# –®–ê–ì 6: –ü–†–û–í–ï–†–ö–ê –ò –£–°–¢–ê–ù–û–í–ö–ê MYSQL
# =============================================================================

print_step "–®–ê–ì 6/10: –ü—Ä–æ–≤–µ—Ä–∫–∞ MySQL"

MYSQL_INSTALLED=false

# –ü—Ä–æ–≤–µ—Ä–∫–∞ MySQL —á–µ—Ä–µ–∑ Homebrew
if brew list mysql 2>/dev/null | grep -q mysql; then
    MYSQL_INSTALLED=true
    MYSQL_PATH="/usr/local/bin/mysql"
    print_success "MySQL –∏–∑ Homebrew –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ MySQL
if [ -f "/usr/local/mysql/bin/mysql" ]; then
    MYSQL_INSTALLED=true
    MYSQL_PATH="/usr/local/mysql/bin/mysql"
    print_success "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π MySQL –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É mysql
if command -v mysql &> /dev/null; then
    MYSQL_INSTALLED=true
    MYSQL_PATH=$(which mysql)
    print_success "MySQL –Ω–∞–π–¥–µ–Ω: $(mysql --version 2>/dev/null | head -n1)"
fi

if [ "$MYSQL_INSTALLED" = false ]; then
    print_warning "MySQL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    print_info "–í–∞—Ä–∏–∞–Ω—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    echo "  1) Homebrew: brew install mysql"
    echo "  2) –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π: https://dev.mysql.com/downloads/mysql/"
    echo ""
    read -p "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å MySQL —á–µ—Ä–µ–∑ Homebrew? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        brew install mysql
        brew services start mysql
        print_success "MySQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω"
    else
        print_error "MySQL –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞"
        print_info "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MySQL –≤—Ä—É—á–Ω—É—é –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
        exit 1
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ MySQL
if ! pgrep -x "mysqld" > /dev/null; then
    print_warning "MySQL –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ü—ã—Ç–∞—é—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å..."
    
    # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Homebrew
    if brew services list | grep -q mysql; then
        brew services start mysql
        sleep 3
    # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π MySQL
    elif [ -f "/usr/local/mysql/support-files/mysql.server" ]; then
        sudo /usr/local/mysql/support-files/mysql.server start
        sleep 3
    fi
    
    if pgrep -x "mysqld" > /dev/null; then
        print_success "MySQL —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
    else
        print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å MySQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        print_info "–ó–∞–ø—É—Å—Ç–∏—Ç–µ MySQL –≤—Ä—É—á–Ω—É—é:"
        echo "  - System Preferences ‚Üí MySQL ‚Üí Start MySQL Server"
        echo "  - –∏–ª–∏: brew services start mysql"
        exit 1
    fi
else
    print_success "MySQL —É–∂–µ –∑–∞–ø—É—â–µ–Ω"
fi

# =============================================================================
# –®–ê–ì 7: –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô –ü–†–û–ï–ö–¢–ê
# =============================================================================

print_step "–®–ê–ì 7/10: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è composer.json
if [ ! -f "composer.json" ]; then
    print_error "composer.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    print_info "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

print_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Composer..."
composer install --no-interaction --prefer-dist --optimize-autoloader

print_success "PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

print_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é JavaScript –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ npm..."
npm install --silent

print_success "JavaScript –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# =============================================================================
# –®–ê–ì 8: –ù–ê–°–¢–†–û–ô–ö–ê .ENV –§–ê–ô–õ–ê
# =============================================================================

print_step "–®–ê–ì 8/10: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)"

if [ ! -f ".env" ]; then
    if [ -f ".env.example" ]; then
        print_info "–ö–æ–ø–∏—Ä—É—é .env.example –≤ .env..."
        cp .env.example .env
        print_success ".env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"
    else
        print_error ".env.example –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi
else
    print_warning ".env —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    read -p "–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π .env? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cp .env.example .env
        print_success ".env —Ñ–∞–π–ª –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω"
    else
        print_info "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π .env —Ñ–∞–π–ª"
    fi
fi

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è APP_KEY
print_info "–ì–µ–Ω–µ—Ä–∏—Ä—É—é APP_KEY..."
php artisan key:generate --force --no-interaction
print_success "APP_KEY —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

# –ó–∞–ø—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
print_info "\n–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö MySQL:"
echo ""

read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö [food_order]: " DB_NAME
DB_NAME=${DB_NAME:-food_order}

read -p "–í–≤–µ–¥–∏—Ç–µ MySQL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [root]: " DB_USER
DB_USER=${DB_USER:-root}

read -sp "–í–≤–µ–¥–∏—Ç–µ MySQL –ø–∞—Ä–æ–ª—å [–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –µ—Å–ª–∏ –Ω–µ—Ç]: " DB_PASS
echo ""

read -p "–í–≤–µ–¥–∏—Ç–µ MySQL —Ö–æ—Å—Ç [127.0.0.1]: " DB_HOST
DB_HOST=${DB_HOST:-127.0.0.1}

read -p "–í–≤–µ–¥–∏—Ç–µ MySQL –ø–æ—Ä—Ç [3306]: " DB_PORT
DB_PORT=${DB_PORT:-3306}

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞
print_info "–û–±–Ω–æ–≤–ª—è—é .env —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ë–î..."

sed -i '' "s/^DB_CONNECTION=.*/DB_CONNECTION=mysql/" .env
sed -i '' "s/^DB_HOST=.*/DB_HOST=${DB_HOST}/" .env
sed -i '' "s/^DB_PORT=.*/DB_PORT=${DB_PORT}/" .env
sed -i '' "s/^DB_DATABASE=.*/DB_DATABASE=${DB_NAME}/" .env
sed -i '' "s/^DB_USERNAME=.*/DB_USERNAME=${DB_USER}/" .env
sed -i '' "s/^DB_PASSWORD=.*/DB_PASSWORD=${DB_PASS}/" .env

print_success "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo ""
read -p "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    read -p "–í–≤–µ–¥–∏—Ç–µ Telegram Bot Token: " TG_TOKEN
    read -p "–í–≤–µ–¥–∏—Ç–µ Telegram Chat ID: " TG_CHAT_ID
    
    sed -i '' "s/^TELEGRAM_BOT_TOKEN=.*/TELEGRAM_BOT_TOKEN=${TG_TOKEN}/" .env
    sed -i '' "s/^TELEGRAM_CHAT_ID=.*/TELEGRAM_CHAT_ID=${TG_CHAT_ID}/" .env
    
    print_success "Telegram –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
fi

# =============================================================================
# –®–ê–ì 9: –°–û–ó–î–ê–ù–ò–ï –ò –ù–ê–°–¢–†–û–ô–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•
# =============================================================================

print_step "–®–ê–ì 9/10: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL
print_info "–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL..."

MYSQL_CMD="mysql -h${DB_HOST} -P${DB_PORT} -u${DB_USER}"
if [ -n "$DB_PASS" ]; then
    MYSQL_CMD="$MYSQL_CMD -p${DB_PASS}"
fi

if ! $MYSQL_CMD -e "SELECT 1;" &> /dev/null; then
    print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MySQL"
    print_info "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env —Ñ–∞–π–ª–µ"
    print_info "–ü–∞—Ä–æ–ª—å: ${DB_PASS:-<–ø—É—Å—Ç–æ>}"
    exit 1
fi

print_success "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL —É—Å–ø–µ—à–Ω–æ"

# –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
print_info "–°–æ–∑–¥–∞—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö '${DB_NAME}'..."
$MYSQL_CMD -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" 2>/dev/null || true
print_success "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞"

# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
print_info "–í—ã–ø–æ–ª–Ω—è—é –º–∏–≥—Ä–∞—Ü–∏–∏..."
php artisan migrate --force --no-interaction

if [ $? -eq 0 ]; then
    print_success "–ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    print_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
    print_info "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: php artisan migrate"
    exit 1
fi

# –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
read -p "–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ë–î —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    print_info "–ó–∞–ø–æ–ª–Ω—è—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
    php artisan db:seed --force --no-interaction
    print_success "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
fi

# =============================================================================
# –®–ê–ì 10: –°–ë–û–†–ö–ê FRONTEND
# =============================================================================

print_step "–®–ê–ì 10/10: –°–±–æ—Ä–∫–∞ frontend"

print_info "–ö–æ–º–ø–∏–ª–∏—Ä—É—é frontend —Ä–µ—Å—É—Ä—Å—ã (Vite + Bootstrap 5)..."
npm run build

if [ $? -eq 0 ]; then
    print_success "Frontend —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω"
else
    print_warning "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ frontend"
    print_info "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: npm run build"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏ –¥–ª—è storage
print_info "–°–æ–∑–¥–∞—é —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –¥–ª—è storage..."
php artisan storage:link --force
print_success "Storage –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
print_info "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
php artisan config:cache
php artisan route:cache
php artisan view:cache
print_success "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# =============================================================================
# –§–ò–ù–ê–õ: –£–°–ü–ï–®–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê
# =============================================================================

clear
echo -e "${GREEN}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                               ‚ïë
‚ïë   ‚úì‚úì‚úì –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û! ‚úì‚úì‚úì                       ‚ïë
‚ïë                                                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}\n"

print_success "–ü—Ä–æ–µ–∫—Ç Food Order –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"
echo ""

print_info "üìä –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–†–û–ï–ö–¢–ï:"
echo ""
echo "  üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:     $(pwd)"
echo "  üêò PHP –≤–µ—Ä—Å–∏—è:      $(php -v | head -n1 | awk '{print $2}')"
echo "  üéº Composer:        $(composer --version --no-ansi | head -n1 | awk '{print $3}')"
echo "  üì¶ Node.js:         $(node -v)"
echo "  üóÑÔ∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:    ${DB_NAME} (MySQL)"
echo ""

print_info "üöÄ –ö–ê–ö –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–û–ï–ö–¢:"
echo ""
echo "  1Ô∏è‚É£  –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:"
echo "     ${CYAN}php artisan serve${NC}"
echo ""
echo "  2Ô∏è‚É£  –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É (—Å–µ—Ä–≤–µ—Ä + Vite):"
echo "     ${CYAN}composer run dev${NC}"
echo ""
echo "  3Ô∏è‚É£  –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
echo "     ${CYAN}http://localhost:8000${NC}"
echo ""

print_info "üë§ –¢–ï–°–¢–û–í–´–ï –ê–ö–ö–ê–£–ù–¢–´:"
echo ""
echo "  ${YELLOW}–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:${NC}"
echo "  üì± –¢–µ–ª–µ—Ñ–æ–Ω: +375(29) 123-45-67"
echo "  üîë –ü–∞—Ä–æ–ª—å:  password"
echo ""

print_info "üìö –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´:"
echo ""
echo "  ‚Ä¢ –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞:       ${CYAN}php artisan make:admin${NC}"
echo "  ‚Ä¢ –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à:         ${CYAN}php artisan cache:clear${NC}"
echo "  ‚Ä¢ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å frontend: ${CYAN}npm run build${NC}"
echo "  ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:       ${CYAN}tail -f storage/logs/laravel.log${NC}"
echo ""

print_info "üìñ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø:"
echo ""
echo "  ‚Ä¢ README.md - –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
echo "  ‚Ä¢ INSTALLATION.md - –¥–µ—Ç–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞"
echo "  ‚Ä¢ –ü–†–û–°–¢–ê–Ø_–ò–ù–°–¢–†–£–ö–¶–ò–Ø.md - –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö"
echo ""

print_info "üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo ""
echo "  1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: ${CYAN}php artisan serve${NC}"
echo "  2. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8000"
echo "  3. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
echo "  4. –ù–∞—á–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É —Å –ø—Ä–æ–µ–∫—Ç–æ–º!"
echo ""

echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo -e "‚ïë           üéâ –ì–æ—Ç–æ–≤–æ! –£—Å–ø–µ—Ö–æ–≤ —Å –ø—Ä–æ–µ–∫—Ç–æ–º! üéâ                  ‚ïë"
echo -e "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å–µ–π—á–∞—Å? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    print_info "–ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä –Ω–∞ http://localhost:8000..."
    print_warning "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    sleep 2
    php artisan serve
fi
