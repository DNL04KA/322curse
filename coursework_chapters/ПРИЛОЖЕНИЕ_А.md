ПРИЛОЖЕНИЕ А
(обязательное)

Программный код функции приложения

− Представление страницы ресторана (Blade):
resources/views/restaurants/show.blade.php

```blade
@extends('layouts.app')

@section('title', $restaurant->name)

@section('content')
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ route('home') }}">Рестораны</a></li>
                <li class="breadcrumb-item active">{{ $restaurant->name }}</li>
            </ol>
        </nav>
    </div>
</div>

− <div class="row mb-4">
    <div class="col-md-8">
        <h1>
            <i class="fas fa-utensils text-primary"></i> {{ $restaurant->name }}
        </h1>
        @if($restaurant->description)
            <p class="lead">{{ $restaurant->description }}</p>
        @endif
    </div>
    <div class="col-md-4 text-md-end">
        <p class="mb-1">
            <i class="fas fa-map-marker-alt text-muted"></i> {{ $restaurant->address }}
        </p>
        @if($restaurant->phone)
            <p class="mb-1">
                <i class="fas fa-phone text-muted"></i> {{ $restaurant->phone }}
            </p>
        @endif
    </div>
</div>

− @php
    $groupedDishes = $restaurant->dishes->where('is_available', true)->groupBy('category');
@endphp

− @if($groupedDishes->count() > 0)
    @foreach($groupedDishes as $category => $dishes)
        <div class="row mb-5">
            <div class="col-12">
                <h3 class="mb-3 border-bottom pb-2">
                    <i class="fas fa-utensils text-primary"></i> {{ $category }}
                    <span class="badge bg-primary ms-2">{{ $dishes->count() }}</span>
                </h3>
            </div>
            @foreach($dishes as $dish)
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm dish-card">
                        @if($dish->image)
                            <img src="{{ asset('storage/' . $dish->image) }}" 
                                 class="card-img-top" 
                                 alt="{{ $dish->name }}" 
                                 style="height: 200px; object-fit: cover;">
                        @else
                            <div class="card-img-top bg-light d-flex align-items-center 
                                        justify-content-center" style="height: 200px;">
                                <i class="fas fa-utensils fa-3x text-muted"></i>
                            </div>
                        @endif
−                         <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ $dish->name }}</h5>
                            @if($dish->description)
                                <p class="card-text text-muted">
                                    {{ Str::limit($dish->description, 80) }}
                                </p>
                            @endif

                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="h5 text-primary mb-0">
                                        {{ number_format($dish->price, 2, ',', ' ') }} BYN
                                    </span>
                                </div>
−                                 <div class="d-grid gap-2">
                                    <a href="{{ route('dishes.show', $dish) }}" 
                                       class="btn btn-outline-primary">
                                        <i class="fas fa-eye"></i> Подробнее
                                    </a>
                                    <form action="{{ route('cart.add', $dish) }}" 
                                          method="POST" 
                                          class="add-to-cart-form d-inline">
                                        @csrf
                                        <div class="input-group">
                                            <input type="number" name="quantity" 
                                                   class="form-control" value="1" 
                                                   min="1" max="10" style="max-width: 80px;">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-cart-plus"></i> В корзину
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            @endforeach
        </div>
    @endforeach
@else
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h4>Меню недоступно</h4>
                <p>В данный момент меню этого ресторана недоступно.</p>
                <a href="{{ route('home') }}" class="btn btn-primary">
                    Вернуться к ресторанам
                </a>
            </div>
        </div>
    </div>
@endif
@endsection

− @push('scripts')
<script>
// Обработка форм добавления в корзину через AJAX
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.add-to-cart-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const button = this.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;

            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Добавление...';
            button.disabled = true;

−             fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')
                                            .getAttribute('content'),
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    animateToCart(button.closest('.card'));
                    animateCartCounter();
                    showToast(data.message, 'success');
                    updateCartCounter(data.cart_count);
                } else {
                    showToast('Ошибка при добавлении в корзину', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Произошла ошибка', 'danger');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        });
    });

−     function updateCartCounter(count) {
        const cartBadge = document.querySelector('.navbar-nav a[href*="cart"] .badge');
        if (cartBadge) {
            cartBadge.textContent = count;
            cartBadge.style.display = count > 0 ? 'inline-block' : 'none';
        }
    }
});
</script>
@endpush
```

− Контроллер ресторана (PHP):
app/Http/Controllers/RestaurantController.php

```php
<?php

namespace App\Http\Controllers;

use App\Models\Restaurant;
use Illuminate\Http\Request;

− class RestaurantController extends Controller
{
    // Отображение списка ресторанов
    public function index()
    {
        $restaurants = Restaurant::with('dishes')
            ->where('is_active', true)
            ->orderBy('name')
            ->get();

        return view('restaurants.index', compact('restaurants'));
    }

−     // Отображение страницы ресторана с меню
    public function show(string $id)
    {
        $restaurant = Restaurant::with('dishes')->findOrFail($id);

        return view('restaurants.show', compact('restaurant'));
    }
}
```

− Модель ресторана:
app/Models/Restaurant.php

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

− class Restaurant extends Model
{
    protected $fillable = [
        'name', 'description', 'address', 'phone', 'image', 'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean',
    ];

−     // Связь с блюдами (один ко многим)
    public function dishes()
    {
        return $this->hasMany(Dish::class);
    }

    // Связь с заказами через блюда
    public function orders()
    {
        return $this->hasManyThrough(Order::class, Dish::class);
    }
}
```

− Контроллер заказов:
app/Http/Controllers/OrderController.php

```php
<?php

namespace App\Http\Controllers;

use App\Models\Dish;
use App\Models\Order;
use App\Models\OrderItem;
use App\Services\TelegramService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

− class OrderController extends Controller
{
    // Создание заказа
    public function store(Request $request)
    {
        $deliveryTime = null;
        if ($request->filled(['delivery_date', 'delivery_time_select'])) {
            $deliveryTime = $request->delivery_date . ' ' . 
                           $request->delivery_time_select . ':00';
        }

−         // Валидация данных
        $request->validate([
            'customer_name' => 'required|string|max:255',
            'customer_email' => 'nullable|email|max:255',
            'country_code' => 'required|string|regex:/^\+[1-9]\d{0,3}(\s?\d{0,3})?$/',
            'phone' => 'required|string|max:20',
            'city' => 'required|string|max:100',
            'street' => 'required|string|max:255',
            'delivery_date' => 'nullable|date|after_or_equal:today',
            'notes' => 'nullable|string|max:1000',
        ]);

        $userId = auth()->id();
        $cart = session()->get('cart', []);

        if (empty($cart)) {
            return redirect()->route('cart.index')->with('error', 'Корзина пуста!');
        }

−         // Расчет суммы и проверка доступности блюд
        $total = 0;
        $unavailableDishes = [];

        foreach ($cart as $dishId => $item) {
            $dish = Dish::with('restaurant')->find($dishId);

            if (!$dish || !$dish->is_available || !$dish->restaurant->is_active) {
                $unavailableDishes[] = $dish->name ?? 'Неизвестное блюдо';
                unset($cart[$dishId]);
                continue;
            }

            $total += $dish->price * $item['quantity'];
        }

        session()->put('cart', $cart);

        if (!empty($unavailableDishes)) {
            return back()->withErrors([
                'dishes' => 'Следующие блюда недоступны: ' . 
                           implode(', ', $unavailableDishes)
            ])->withInput();
        }

−         // Форматирование телефона и адреса
        $formattedPhone = $request->country_code . ' ' . $request->phone;
        $deliveryAddress = $request->city . ', ' . $request->street;
        if ($request->entrance) $deliveryAddress .= ', подъезд ' . $request->entrance;
        if ($request->floor) $deliveryAddress .= ', этаж ' . $request->floor;
        if ($request->apartment) $deliveryAddress .= ', кв. ' . $request->apartment;

−         // Создание заказа в транзакции MySQL
        $order = DB::transaction(function () use (
            $request, $cart, $total, $deliveryAddress, 
            $userId, $formattedPhone, $deliveryTime
        ) {
            $order = Order::create([
                'user_id' => $userId,
                'customer_name' => $request->customer_name,
                'customer_email' => $request->customer_email,
                'customer_phone' => $formattedPhone,
                'delivery_address' => $deliveryAddress,
                'total_amount' => $total,
                'delivery_time' => $deliveryTime,
                'notes' => $request->notes,
                'status' => 'pending',
            ]);

−             // Создание позиций заказа
            foreach ($cart as $dishId => $item) {
                $dish = Dish::find($dishId);
                if ($dish) {
                    OrderItem::create([
                        'order_id' => $order->id,
                        'dish_id' => $dish->id,
                        'quantity' => $item['quantity'],
                        'price' => $dish->price,
                        'special_instructions' => $item['special_instructions'] ?? '',
                    ]);
                }
            }

            return $order;
        });

−         // Отправка уведомления в Telegram
        $telegramService = app(TelegramService::class);
        $telegramService->sendNewOrderNotification([
            'id' => $order->id,
            'customer_name' => $request->customer_name,
            'customer_phone' => $formattedPhone,
            'total' => number_format($total, 2, ',', ' '),
            'address' => $deliveryAddress,
        ]);

        session()->forget('cart');

        return redirect()->route('orders.success')
            ->with('success', 'Заказ успешно оформлен!');
    }

−     // Обновление статуса заказа (AJAX)
    public function updateStatus(Request $request, Order $order)
    {
        $request->validate([
            'status' => 'required|in:pending,confirmed,preparing,delivering,delivered,cancelled',
        ]);

        $oldStatus = $order->status;
        $order->update(['status' => $request->status]);

        $this->sendAdminStatusNotification($order, $oldStatus);

        return response()->json(['success' => true, 'status' => $order->status]);
    }

−     // Отправка уведомления об изменении статуса
    protected function sendAdminStatusNotification(Order $order, string $oldStatus)
    {
        $statusText = match ($order->status) {
            'pending' => 'Ожидает подтверждения',
            'confirmed' => 'Подтвержден',
            'preparing' => 'Готовится',
            'delivering' => 'Доставляется',
            'delivered' => 'Доставлен',
            'cancelled' => 'Отменен',
            default => 'Неизвестен'
        };

        $orderData = [
            'id' => $order->id,
            'customer_name' => $order->customer_name,
            'customer_phone' => $order->customer_phone,
            'status' => $order->status,
            'status_text' => $statusText,
        ];

        $telegramService = app(TelegramService::class);
        $telegramService->sendOrderStatusUpdate($orderData);
    }
}
```

− Модель заказа:
app/Models/Order.php

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

− class Order extends Model
{
    protected $fillable = [
        'user_id', 'customer_name', 'customer_email', 'customer_phone',
        'delivery_address', 'total_amount', 'status', 'delivery_time', 'notes'
    ];

    protected $casts = [
        'total_amount' => 'decimal:2',
        'delivery_time' => 'datetime',
    ];

−     // Связь с пользователем
    public function user()
    {
        return $this->belongsTo(User::class);
    }

    // Связь с позициями заказа
    public function orderItems()
    {
        return $this->hasMany(OrderItem::class);
    }

    // Связь с блюдами через промежуточную таблицу
    public function dishes()
    {
        return $this->belongsToMany(Dish::class, 'order_items')
            ->withPivot('quantity', 'price', 'special_instructions')
            ->withTimestamps();
    }
}
```
